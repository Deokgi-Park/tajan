<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8"/>

        <!-- ë°˜ì‘í˜•ìœ¼ë¡œ ë™ì‘í•˜ê²Œ í•¨ -->
        <meta title="viewport" content="width=device-width, initial-scale=1.0"/>

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">

        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

        <!-- Bulma -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"/>

        <!-- Font awesome -->
        <script defer src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"></script>
        <script src="https://kit.fontawesome.com/eab63039c9.js" crossorigin="anonymous"></script>

        <title>ë§ˆì´ í˜ì´ë³´ë¦¿ ë¬´ë¹„ | í¬ë˜í”„í†¤ ì •ê¸€</title>

            <style>
                .center {
                    text-align: center;
                }
    
                .sorter-box {
                    width: 600px;
                }
    
                .movie-list {
                    width: 600px;
                    margin: 20px auto 0 auto;
                }
    
                .movie-title {
                    display: inline-block;
                }
    
                .movie-title:hover {
                    text-decoration: underline;
                }
    
                .movie-poster {
                    height: 200px;
                    width: 200px;
                    padding: 25px;
                }
    
                .card {
                    margin-bottom: 15px;
                    padding-bottom: 15px;
                    overflow: hidden; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìˆ¨ê¹ë‹ˆë‹¤. */
                    height: auto; /* ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•©ë‹ˆë‹¤. */
                }
    
                #trash-icon {
                    color: mediumaquamarine;
                    margin-top: 4px;
                }
    
                #trash-button {
                    border: none;
                    padding-left: 2px;
                    padding-bottom: 20px;
                    color: mediumaquamarine;
                }

                .movie-title {
                    font-size: 30px;
                    font-weight: bold;
                    text-align: left;
                }

                .movie-content {
                    font-size: 18px;
                    text-align: left;
                }

                .movie-title:link {
                    color: #4a4a4a;
                }

                .movie-title:visited {
                    color: #4a4a4a;
                }

                .movie-button2:link {
                    color: #f05650;
                }

                .movie-button2:visited {
                    color: #f05650;
                }

                .movie-button1:link {
                    color: skyblue;
                }

                .movie-button1:visited {
                    color: skyblue;
                }

                .movie-button4:link {
                    color: #f05650;
                }

                .movie-button4:visited {
                    color: #f05650;
                }

                .movie-button3:link {
                    color: skyblue;
                }

                .movie-button3:visited {
                    color: skyblue;
                }

                #movie-poster-div {
                    width: 170px;
                    height: 200px;
                    float: left;
                }

                #movie-meta {
                    width: 400px;
                    height: 200px;
                    text-align: left;
                    float: left;
                    padding-top: 52px;
                    padding-bottom: 25px;
                }

                #full {
                    width: 600px;
                    height: 200px;
                }

                .selected {
                    width: 600px;
                    height: 30px;
                }

                .select1 {
                    width: 299px;
                    height: 30px;
                    float: left;
                    text-align: center;
                    font-weight: bold;
                    color: skyblue;

                }

                .select2 {
                    width: 299px;
                    height: 30px;
                    float: right;
                    text-align: center;
                    font-weight: bold;
                    color: #f05650;
                }

    
            </style>

        <script>
            const Sort = {
                BY_LIKES: "likes",
                BY_VIEWERS: "viewers",
                BY_DATE: "date",
            };

            let sortMode = Sort.BY_LIKES
            let trashMode = false

            $(document).ready(function () {
                // ì˜í™” ë³´ì—¬ì£¼ê¸°
                showMovie()

                // í˜„ì¬ ì ìš©ë˜ê³  ìˆëŠ” ì •ë ¬ ë°©ì‹ì˜ ë²„íŠ¼ì— ëˆŒë ¤ì ¸ ë³´ì´ëŠ” íš¨ê³¼
                displaySorter()

                // íœ´ì§€í†µ ëª¨ë“œì— ë”°ë¼ ë©”ë‰´ë¥¼ ë‹¤ë¥´ê²Œ ë°”ê¿”ì£¼ê¸°
                displayTrashMode(trashMode)
            });

            function showMovie() {
                $('#movie-box').empty()

                // íœ´ì§€í†µ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ apië¡œ ìš”ì²­ì„ ë³´ë‚¸ë‹¤
                if (trashMode == false) {
                    $.ajax({
                        type: "GET",
                        url: "/api/list",
                        data: {'sortMode': sortMode},
                        success: function(response) {
                            if (response['result'] != 'success') {
                                alert(sortMode + ' ìˆœìœ¼ë¡œ ì˜í™” ëª©ë¡ ë°›ì•„ì˜¤ê¸° ì‹¤íŒ¨!')
                                return
                            }
                            let movies = response['movies_list']
                            addMovieCards(movies, false)
                        },
                    })
                } else {
                    $.ajax({
                        type: "GET",
                        url: "/api/trash_list",
                        data: {'sortMode' : sortMode},
                        success: function(response) {
                            if(response['result'] != 'success') {
                                alert('íœ´ì§€í†µ ì¡°íšŒ ì‹¤íŒ¨ !')
                                return
                            }
                            else {
                                let movies = response['movies_list']

                                addMovieCards(movies, true)
                            }
                        }
                    })
                }
            }
            // ì¹´ë“œ ë§Œë“¤ê¸°
            function addMovieCards(movies, trashMode) {
                for (let i = 0; i < movies.length; i++) {
                    let movie = movies[i]

                    let id = movie['_id']
                    let title = movie['title']
                    let viewers = movie['viewers'].toLocaleString()
                    let likes = movie['likes']
                    let url = movie['info_url']
                    let posterUrl = movie['poster_url']
                    let openMonth = movie['open_month']
                    let openYear = movie['open_year']
                    let openDay = movie['open_day']

                    let cardContentHtml = `
                        <div id="full">
                        <div id="movie-poster-div">
                            <img src="${posterUrl}" class="movie-poster"/>
                        </div>
                        <div id="movie-meta">
                        <a href="${url}" target="_blank" class="movie-title">${title}</a><br>
                        <div class="movie-content">
                        <span class="icon"><i class="fas fa-thumbs-up"></i></span><span class="movie-likes">${likes}</span><br>
                        <span class="movie-viewers">ëˆ„ì ê´€ê°ìˆ˜ ${viewers} ëª…</span><br>
                        <span class="movie-date">ê°œë´‰ì¼ ${openYear}.${openMonth}.${openDay}</span>
                        </div>
                        </div>
                        </div>
                        <hr>
                        
                    `

                    // íœ´ì§€í†µ ì—¬ë¶€ì— ë”°ë¼ì„œ í•˜ìœ„ ë²„íŠ¼ ë‹¤ë¥´ê²Œ ì„¤ì •
                    let cardFooterHtml = ''
                    if (trashMode == false) {
                        cardFooterHtml = `
                        <div class="selected">
                        <div class="select1">
                            <a class="movie-button1" href="#" onclick="likeMovie('${id}')">
                            ìœ„ë¡œ!
                            </a>
                            <i class="fa-regular fa-thumbs-up"></i>
                        </div>
                        <div class="select2">
                            <a class="movie-button2" href="#" onclick="trashMovie('${id}')">
                            íœ´ì§€í†µìœ¼ë¡œ
                            </a>
                            <i class="fa-solid fa-trash-arrow-up"></i>
                        </div>
                        </div>
                        `
                    } else {
                        cardFooterHtml = `
                        <div class="selected">
                            <div class="select1">
                            <a class="movie-button3" href="#" onclick="restoreMovie('${id}')">
                            ë³µêµ¬í•˜ê¸°
                            </a>
                            <i class="fa-regular fa-heart"></i>
                            </div>
                            <div class="select2">
                            <a class="movie-button4" href="#" onclick="deleteMovie('${id}')">
                            ì˜êµ¬ì‚­ì œ
                            </a>
                            <i class="fa-solid fa-ban"></i>
                            </div>
                        </div>
                        `
                    }

                    $('#movie-box').append(`
                        <div class="card">
                            ${cardContentHtml}
                            ${cardFooterHtml}
                        </div>
                    `)
                }
            }

            function likeMovie(movieId) {
                $.ajax({
                    type: "POST",
                    url: "/api/like",
                    data: {'movieId' : movieId},
                    success: function (response) {
                        if (response['result'] == 'success') {
                            alert('ì¢‹ì•„ìš” ì™„ë£Œ!')
                            showMovie()
                        } else {
                            alert('ì¢‹ì•„ìš” ì‹¤íŒ¨ã… ã… ')
                        }
                    }
                });
            }

            function trashMovie(movieId) {
                $.ajax({
                    type: "POST",
                    url: "/api/goTrash",
                    data: {'movieId' : movieId},
                    success: function(response) {
                        if(response['result'] != 'success') {
                            alert('íœ´ì§€í†µ ë³´ë‚´ê¸° ì‹¤íŒ¨ !')
                        }
                        else {
                            alert('íœ´ì§€í†µìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤ !')
                            showMovie()
                        }
                    }
                })
            }

            function restoreMovie(movieId) {
                $.ajax({
                    type: "POST",
                    url: "/api/noTrash",
                    data: {'movieId' : movieId},
                    success: function(response) {
                        if(response['result'] != 'success') {
                            alert('ë˜ì‚´ë¦¬ê¸° ì‹¤íŒ¨ !')
                        }
                        else {
                            alert('ë˜ì‚´ë¦¬ê¸° ì„±ê³µ !')
                            showMovie()
                        }
                    }
                })
            }

            function deleteMovie(movieId) {
                $.ajax({
                    type: "POST",
                    url: "/api/deathTrash",
                    data: {'movieId' : movieId},
                    success: function(response) {
                        if(response['result'] != 'success') {
                            alert('ì˜êµ¬ì‚­ì œ ì‹¤íŒ¨ !')
                        }
                        else {
                            alert('ì˜êµ¬ì‚­ì œ ì„±ê³µ !')
                            showMovie()
                        }
                    }
                })
            }

            // ì •ë ¬ ë²„íŠ¼ í´ë¦­í•˜ë©´ í˜¸ì¶œ
            function changeSorter(newMode) {
                if (sortMode == newMode) {
                    return
                }

                sortMode = newMode
                displaySorter()
                showMovie()
            }

            // ì •ë ¬ ê¸°ì¤€ì— ë”°ë¼ í•´ë‹¹ ë²„íŠ¼ë§Œ í™œì„±í™” ì‹œí‚¤ê³  ë‹¤ë¥¸ ë²„íŠ¼ì€ ë¹„í™œì„±í™” ì‹œí‚´
            function displaySorter() {
                // ë²„íŠ¼ ëª¨ë‘ í™œì„±í™”
                document.getElementById('sorter-likes').classList.remove('disabled')
                document.getElementById('sorter-viewers').classList.remove('disabled')
                document.getElementById('sorter-date').classList.remove('disabled')

                // sortModeì— ë§ëŠ” ë²„íŠ¼ë§Œ ë¹„í™œì„±í™”
                let bee = 'sorter-' + sortMode
                document.getElementById(bee).classList.add('disabled')
            }

            function displayTrashMode(trashMode) {
                if(trashMode == false) {
                    $('#trash-button').text('íœ´ì§€í†µ ë³´ê¸°')
                }
                else {
                    $('#trash-button').text('íœ´ì§€í†µ ë‚˜ê°€ê¸°')
                }
            }

            function changeTrash() {
                if(trashMode == false) {
                    trashMode = true
                }
                else {
                    trashMode = false
                }

		showMovie()
                displayTrashMode(trashMode)
            }

        </script>
    </head>

    <body>
        <!-- ì œëª© ë¶€ë¶„ -->
        <section class="hero is-warning">
            <div class="hero-body">
                <div class="container center">
                    <h1 class="title">
                        ë§ˆì´ í˜ì´ë³´ë¦¿ ë¬´ë¹„ğŸ˜†
                    </h1>
                    <h2 class="subtitle">
                        ìˆœìœ„ë¥¼ ë§¤ê²¨ë´…ì‹œë‹¤
                    </h2>
                </div>
            </div>
        </section>

        <!-- ì •ë ¬ ì˜µì…˜ ë¶€ë¶„ -->
        <div class="mx-auto sorter-box">
            <div class="btn-group m-3 mx-auto w-100">
                <a href="#" class="btn btn-primary" id="sorter-likes" onclick="changeSorter('likes')">ì¢‹ì•„ìš” ìˆœìœ¼ë¡œ ì •ë ¬</a>
                <a href="#" class="btn btn-primary" id="sorter-viewers" onclick="changeSorter('viewers')">ëˆ„ì ê´€ê°ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬</a>
                <a href="#" class="btn btn-primary" id="sorter-date" onclick="changeSorter('date')">ê°œë´‰ì¼ ìˆœìœ¼ë¡œ ì •ë ¬</a>
            </div>
        </div>

        <!-- "íœ´ì§€í†µ ë³´ê¸°" ë¶€ë¶„ -->
        <div class="mx-auto sorter-box">
            <span class="d-flex justify-content-end">
                <div id="trash-mode-box">
                    <i id="trash-icon" class="fa-solid fa-trash"></i>
                    <button id="trash-button" class="button is-ghost" onclick="changeTrash()">íœ´ì§€í†µ ë³´ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ë™ì ìœ¼ë¡œ ì˜í™” ëª©ë¡ì´ ë“¤ì–´ê°ˆ ë¶€ë¶„ -->
        <div class="movie-list" id="movie-box">

        </div>
    </body>
</html>
